<!DOCTYPE html>
<html lang="en">
<head>
    <title>Steve Landey – What It's Like to Write a Sphinx Extension</title>

    <meta name="viewport" content="width=device-width">
    <meta charset="UTF-8">

    <link href='http://fonts.googleapis.com/css?family=Playfair+Display:400,700,400italic&subset=latin,latin-ext' rel='stylesheet'>
    <link href='http://fonts.googleapis.com/css?family=Playfair+Display+SC' rel='stylesheet'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet'>

    <link rel="stylesheet" href="http://steveasleep.com/css/reset.css" />
    <link rel="stylesheet" href="http://steveasleep.com/css/pygments.css" />
    <link rel="stylesheet" href="http://steveasleep.com/css/style.css" />

    <meta charset="utf-8" />
      <link href="http://steveasleep.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Steve Landey Full Atom Feed" />
      <link href="http://steveasleep.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Steve Landey Full RSS Feed" />
    <!--
      <link href="http://steveasleep.com/feeds/posts.atom.xml" type="application/atom+xml" rel="alternate" title="Steve Landey Categories Atom Feed" />
    -->

    <script src="http://steveasleep.com/js/hyphenate.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://steveasleep.com/js/main.js"></script>

</head>

<body>
  <header id="banner" class="body">
    <h1>
      <a href="http://steveasleep.com">
        <!--Steve Landey <strong></strong>-->
        <!--Steve Johnson&rsquo;s<br>partial creative output-->
        Steve Landey
      </a>
    </h1>
    <div class="header-links">
        <a href="mailto:randos@steve.steveasleep.com">Email</a>
        <a href="https://github.com/irskep">GitHub</a>
        <a href="https://slamjamsen.bandcamp.com">Bandcamp</a>
        <a href="https://irskep.itch.io">itch.io</a>
        <a href="https://www.last.fm/user/irskep">last.fm</a>
    </div>
  </header>

  <div id="layoutcontainer">
    <div id="pagecontainer">
      <nav id="menu">
        <ul>
            <li><a href="https://blog.steveasleep.com/">Blog</a></li>
            <li><a href="https://twitter.com/irskep">Twitter</a></li>
            <li><a href="http://steveasleep.com/resume.html">Résumé</a></li>
            <li><a href="http://steveasleep.com/games.html">All games</a></li>
            <li><a href="https://irskep.itch.io/dr-hallervorden">Dr. Hallervorden</a></li>
            <li><a href="https://irskep.itch.io/powerq">Power-Q</a></li>
            <li><a href="https://irskep.itch.io/roguebasement">Rogue Basement</a></li>
            <li><a href="http://sendimals.com">Sendimals</a></li>
            <li><a href="https://itunes.apple.com/us/app/asana-organize-tasks-work/id489969512?mt=8">Asana</a></li>
            <li><a href="https://asana.github.io/Drawsana/">Drawsana</a></li>
            <li><a href="http://literallycanvas.com/">Literally Canvas</a></li>
            <li><a href="http://steveasleep.com.com/clubsandwich">clubsandwich</a></li>
            <li><a href="http://steveasleep.com/BearLibTerminal-Swift/">BearLibTerminal-Swift</a></li>
            <li><a href="http://steveasleep.com/jumbogrove">Jumbo Grove</a></li>
            <li><a href="https://sphinx-better-theme.readthedocs.io/en/latest/">sphinx-better-theme</a></li>
        </ul>
      </nav>

  <section id="content" class="body"><article class="article">
      <header class="article-header">
    <h1 class="entry-title">
      <a href="http://steveasleep.com/drafts/what-its-like-to-write-a-sphinx-extension.html" rel="bookmark" title="Permalink to What It's Like to Write a Sphinx Extension">
        What It's Like to Write a Sphinx Extension
      </a>
    </h1>
    <div class="post-info">
        <time class="published" datetime="2013-08-20T00:00:00-07:00">
          August 20, 2013
        </time>
    </div>
  </header>

    <div class="entry-content hyphenate"><h1 id="why-i-wanted-to-write-a-sphinx-extension">Why I wanted to write a Sphinx extension</h1>
<p>As the de facto Director of Documentation for <a href="mrjob">mrjob</a>, I spend a lot of
time dealing with <a href="sphinx">Sphinx</a>—certainly more time than anyone else. So
more than anyone else, I notice pain points in the process of writing
documentation for mrjob.</p>
<p>The pain point I identified most recently was how many places you have to
document a configuration option. You see, almost every option in mrjob can be
set in a config file or on the command line. So it needs to be documented in
the <code>--help</code> string, it needs to have a detailed description on the appropriate
doc page, and it needs to appear in the "quick reference" table.</p>
<p>Let's take the <code>interpreter</code> option as an example. It's defined as an option in
<code>mrjob/options.py</code>:</p>
<div class="highlight"><pre><span></span>opt_group.add_option(
    &#39;--interpreter&#39;, dest=&#39;interpreter&#39;, default=None,
    help=(&quot;Interpreter to run your script, e.g. python or ruby.&quot;)),
</pre></div>


<p>It has an entry in the reference table in <code>configs-reference.rst</code>:</p>
<div class="highlight"><pre><span></span>======================================================= ================================================================== ============================== ================
Option                                                  Switches                                                           Default                        Data type
<span class="gh">======================================================= ================================================================== ============================== ================</span>
<span class="gh">...</span>
<span class="na">:ref:</span><span class="nv">`interpreter &lt;opt_interpreter&gt;`</span>                    <span class="na">:option:</span><span class="nv">`--interpreter`</span>                                            (value of <span class="ge">*python_bin*</span>)        |dt-command|
</pre></div>


<p>(Incomprehensibility of large reStructuredText tables at small column
widths intentionally preserved.)</p>
<p>And finally, it has a description in <code>configs-all-runners.rst</code>:</p>
<div class="highlight"><pre><span></span><span class="p">..</span> <span class="nt">_opt_interpreter:</span>

<span class="gs">**interpreter**</span> (<span class="na">:option:</span><span class="nv">`--interpreter`</span>)
    Interpreter to launch your script with. Defaults to the value
    of <span class="gs">**python_bin**</span>. Change this if you&#39;re using a language
    besides Python 2.5-2.7 or if you&#39;re running using
    <span class="na">:py:mod:</span><span class="nv">`virtualenv`</span>.
</pre></div>


<p>The above block contains (in order): an anchor for the reference table entry to
link to, the config file version of the option in bold, the command line
version of the option in the style of the <code>option</code> role (normally italic), and
a description of what the option does.</p>
<p>There are several ways in which the above system of documention an option is
suboptimal.</p>
<ol>
<li>
<p>You have to describe the same option in three places. It's tedious and the
   likelihood of leaving a piece of information out of date is high. (In fact,
   I found several out-of-date descriptions while writing my extension.)</p>
</li>
<li>
<p>reStructuredText (hereafter RST) tables are terrible to define and badly
   implemented. <code>docutils</code>, the library that generates the HTML from the RST,
   generates a <code>&lt;colgroup&gt;</code> element that defines the width of each column based
   on the <em>number of <code>=</code> characters above it in the text definition</em>. When most
   of your table content is actually just link markup, this implementation
   detail balloons the widths of tables.</p>
</li>
</ol>
<p>Additionally, if you increase the length of the longest option name by
   adding a new option <code>--with-a-really-long-name</code>, you have to add whitespace
   to every. single. freaking. table. row.</p>
<ol>
<li>The markup for detailed option descriptions is prone to copy/paste error and
   laziness in formatting on the part of the untrained contributor.</li>
</ol>
<h1 id="how-i-improved-the-situation">How I improved the situation</h1>
<p>I wrote a Sphinx extension that replaces the above process with this one:</p>
<ol>
<li>
<p>Describe the command line option in <code>options.py</code>.</p>
</li>
<li>
<p>Make sure <code>.. mrjob-optlist:: all</code> is somewhere in the documentation, to
   collect all options with <code>:set: all</code>. You basically never need to do this.</p>
</li>
<li>
<p>Describe the option on the appropriate doc page with this syntax:</p>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="p">..</span> <span class="nt">_opt_interpreter:</span>

<span class="p">..</span> <span class="ow">mrjob-opt</span><span class="p">::</span>
    <span class="nc">:config:</span> <span class="nf">interpreter</span>
    <span class="nc">:switch:</span> <span class="nf">--interpreter</span>
    <span class="nc">:type:</span> <span class="nf">:ref:`string &lt;data-type-string&gt;`</span>
    <span class="nc">:set:</span> <span class="nf">all</span>
    <span class="nc">:default:</span> <span class="nf">value of \</span>
      <span class="na">:ref:</span><span class="nv">`python_bin &lt;opt_python_bin&gt;`</span> (<span class="s">``&#39;python&#39;``</span>)

    Interpreter to launch your script with. Defaults to the value
    of <span class="gs">**python_bin**</span>, which is deprecated. Change this if you&#39;re
    using a language besides Python 2.5-2.7 or if you&#39;re running
    using <span class="na">:py:mod:</span><span class="nv">`virtualenv`</span>.
</pre></div>


<p>And you're done.</p>
<p>I'll be the first to admit that the above syntax still has flaws. But it has a
few key advantages:</p>
<ol>
<li>
<p>You don't need to edit the reference table by hand. Fewer duplications of
   text and no idiotic RST tables.</p>
</li>
<li>
<p>You define the different components of the option (config key, command line
   switches, default value) semantically instead of by convention.</p>
</li>
</ol>
<p>In the future, I'd like to have it automatically generate the <code>opt_X</code> and
<code>:type:</code> links to remove even more manual labor from the process of documenting
options, but this is enough of an improvement that I went ahead and submitted a
<a href="pr">pull request</a> for it.</p>
<h1 id="how-i-wrote-the-extension">How I wrote the extension</h1>
<p>This section will describe not only how the code works, but also how I went
about learning how to write Sphinx extensions and how to get the results I
wanted.</p></div>
  </article></section>
    </div>

    <nav id="sidebar">
      <ul>
          <h3>Writing</h3>
            <li><a href="https://blog.steveasleep.com/">Blog</a></li>
            <li><a href="https://twitter.com/irskep">Twitter</a></li>
            <li><a href="http://steveasleep.com/resume.html">Résumé</a></li>
          <h3>Games</h3>
            <li><a href="http://steveasleep.com/games.html">All games</a></li>
            <li><a href="https://irskep.itch.io/dr-hallervorden">Dr. Hallervorden</a></li>
            <li><a href="https://irskep.itch.io/powerq">Power-Q</a></li>
            <li><a href="https://irskep.itch.io/roguebasement">Rogue Basement</a></li>
          <h3>Apps</h3>
            <li><a href="http://sendimals.com">Sendimals</a></li>
            <li><a href="https://itunes.apple.com/us/app/asana-organize-tasks-work/id489969512?mt=8">Asana</a></li>
          <h3>Open Source</h3>
            <li><a href="https://asana.github.io/Drawsana/">Drawsana</a></li>
            <li><a href="http://literallycanvas.com/">Literally Canvas</a></li>
            <li><a href="http://steveasleep.com.com/clubsandwich">clubsandwich</a></li>
            <li><a href="http://steveasleep.com/BearLibTerminal-Swift/">BearLibTerminal-Swift</a></li>
            <li><a href="http://steveasleep.com/jumbogrove">Jumbo Grove</a></li>
            <li><a href="https://sphinx-better-theme.readthedocs.io/en/latest/">sphinx-better-theme</a></li>
      </ul>
    </nav>

  </div>

  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4517625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</body>
</html>