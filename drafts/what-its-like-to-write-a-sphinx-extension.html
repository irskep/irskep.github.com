<!DOCTYPE html>
<html lang="en">
<head>
    <title>Steve Johnson’s Web Presence</title>

    <meta name="viewport" content="width=device-width">
    <meta charset="UTF-8">

    <link href='http://fonts.googleapis.com/css?family=Playfair+Display:400,700,400italic&subset=latin,latin-ext' rel='stylesheet'>
    <link href='http://fonts.googleapis.com/css?family=Playfair+Display+SC' rel='stylesheet'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet'>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="http://steveasleep.com/css/reset.css" />
    <link rel="stylesheet" href="http://steveasleep.com/css/pygments.css" />
    <link rel="stylesheet" href="http://steveasleep.com/css/style.css" />

    <!--
    <meta charset="utf-8" />
      <link href="http://steveasleep.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Steve Johnson’s Web Presence Full Atom Feed" />
      <link href="http://steveasleep.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Steve Johnson’s Web Presence Full RSS Feed" />
      <link href="http://steveasleep.com/feeds/posts.atom.xml" type="application/atom+xml" rel="alternate" title="Steve Johnson’s Web Presence Categories Atom Feed" />
    -->

    <script src="http://steveasleep.com/js/hyphenate.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://steveasleep.com/js/main.js"></script>

</head>

<body id="index" class="home">
  <div id="pagecontainer">
    <header id="banner" class="body">
      <h1>
        <a href="http://steveasleep.com">
          <!--Steve Johnson’s Web Presence <strong></strong>-->
          <!--Steve Johnson&rsquo;s<br>partial creative output-->
          Steve Johnson&rsquo;s<br>Web Presence
        </a>
      </h1>
    </header><!-- /#banner -->

    <nav id="menu">
      <ul>
          <li><a href="http://steveasleep.com/">Read me</a></li>
          <li><a href="http://steveasleep.com/games.html">Games</a></li>
          <li><a href="http://steveasleep.com/open-source.html">Open source</a></li>
          <li><a href="http://steveasleep.com/pyglettutorial.html">Pyglet tutorial</a></li>
          <li><a href="http://thenestmusic.com">The Nest</a></li>
      </ul>
    </nav><!-- /#menu -->
  <section id="content" class="body"><article class="article">
      <header class="article-header">
    <h2 class="entry-title">
      <a href="http://steveasleep.com/drafts/what-its-like-to-write-a-sphinx-extension.html" rel="bookmark" title="Permalink to What It’s Like to Write a Sphinx Extension">
        What It&#8217;s Like to Write a Sphinx&nbsp;Extension
      </a>
    </h2>
    <div class="post-info">
        <time class="published" datetime="2013-08-20T00:00:00-07:00">
          20 Aug 2013
        </time>
    </div>
  </header>

    <div class="entry-content hyphenate"><h1 id="why-i-wanted-to-write-a-sphinx-extension">Why I wanted to write a Sphinx&nbsp;extension</h1>
<p>As the de facto Director of Documentation for <a href="mrjob">mrjob</a>, I spend a lot of
time dealing with <a href="sphinx">Sphinx</a>—certainly more time than anyone else. So
more than anyone else, I notice pain points in the process of writing
documentation for&nbsp;mrjob.</p>
<p>The pain point I identified most recently was how many places you have to
document a configuration option. You see, almost every option in mrjob can be
set in a config file or on the command line. So it needs to be documented in
the <code>--help</code> string, it needs to have a detailed description on the appropriate
doc page, and it needs to appear in the &#8220;quick reference&#8221;&nbsp;table.</p>
<p>Let&#8217;s take the <code>interpreter</code> option as an example. It&#8217;s defined as an option in
<code>mrjob/options.py</code>:</p>
<div class="highlight"><pre><span class="n">opt_group</span><span class="p">.</span><span class="n">add_option</span><span class="p">(</span>
    <span class="err">&#39;</span><span class="o">--</span><span class="n">interpreter</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="err">&#39;</span><span class="n">interpreter</span><span class="err">&#39;</span><span class="p">,</span> <span class="k">default</span><span class="o">=</span><span class="n">None</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&quot;Interpreter to run your script, e.g. python or ruby.&quot;</span><span class="p">)),</span>
</pre></div>


<p>It has an entry in the reference table in <code>configs-reference.rst</code>:</p>
<div class="highlight"><pre>======================================================= ================================================================== ============================== ================
Option                                                  Switches                                                           Default                        Data type
<span class="gh">======================================================= ================================================================== ============================== ================</span>
<span class="gh">...</span>
<span class="na">:ref:</span><span class="nv">`interpreter &lt;opt_interpreter&gt;`</span>                    <span class="na">:option:</span><span class="nv">`--interpreter`</span>                                            (value of <span class="ge">*python_bin*</span>)        |dt-command|
</pre></div>


<p>(Incomprehensibility of large reStructuredText tables at small column
widths intentionally&nbsp;preserved.)</p>
<p>And finally, it has a description in <code>configs-all-runners.rst</code>:</p>
<div class="highlight"><pre><span class="p">..</span> <span class="nt">_opt_interpreter:</span>

<span class="gs">**interpreter**</span> (<span class="na">:option:</span><span class="nv">`--interpreter`</span>)
    Interpreter to launch your script with. Defaults to the value
    of <span class="gs">**python_bin**</span>. Change this if you&#39;re using a language
    besides Python 2.5-2.7 or if you&#39;re running using
    <span class="na">:py:mod:</span><span class="nv">`virtualenv`</span>.
</pre></div>


<p>The above block contains (in order): an anchor for the reference table entry to
link to, the config file version of the option in bold, the command line
version of the option in the style of the <code>option</code> role (normally italic), and
a description of what the option&nbsp;does.</p>
<p>There are several ways in which the above system of documention an option is&nbsp;suboptimal.</p>
<ol>
<li>
<p>You have to describe the same option in three places. It&#8217;s tedious and the
   likelihood of leaving a piece of information out of date is high. (In fact,
   I found several out-of-date descriptions while writing my&nbsp;extension.)</p>
</li>
<li>
<p>reStructuredText (hereafter <span class="caps">RST</span>) tables are terrible to define and badly
   implemented. <code>docutils</code>, the library that generates the <span class="caps">HTML</span> from the <span class="caps">RST</span>,
   generates a <code>&lt;colgroup&gt;</code> element that defines the width of each column based
   on the <em>number of <code>=</code> characters above it in the text definition</em>. When most
   of your table content is actually just link markup, this implementation
   detail balloons the widths of&nbsp;tables.</p>
</li>
</ol>
<p>Additionally, if you increase the length of the longest option name by
   adding a new option <code>--with-a-really-long-name</code>, you have to add whitespace
   to every. single. freaking. table.&nbsp;row.</p>
<ol>
<li>The markup for detailed option descriptions is prone to copy/paste error and
   laziness in formatting on the part of the untrained&nbsp;contributor.</li>
</ol>
<h1 id="how-i-improved-the-situation">How I improved the&nbsp;situation</h1>
<p>I wrote a Sphinx extension that replaces the above process with this&nbsp;one:</p>
<ol>
<li>
<p>Describe the command line option in <code>options.py</code>.</p>
</li>
<li>
<p>Make sure <code>.. mrjob-optlist:: all</code> is somewhere in the documentation, to
   collect all options with <code>:set: all</code>. You basically never need to do&nbsp;this.</p>
</li>
<li>
<p>Describe the option on the appropriate doc page with this&nbsp;syntax:</p>
</li>
</ol>
<div class="highlight"><pre><span class="p">..</span> <span class="nt">_opt_interpreter:</span>

<span class="p">..</span> <span class="ow">mrjob-opt</span><span class="p">::</span>
    <span class="nc">:config:</span> <span class="nf">interpreter</span>
    <span class="nc">:switch:</span> <span class="nf">--interpreter</span>
    <span class="nc">:type:</span> <span class="nf">:ref:`string &lt;data-type-string&gt;`</span>
    <span class="nc">:set:</span> <span class="nf">all</span>
    <span class="nc">:default:</span> <span class="nf">value of \</span>
      <span class="na">:ref:</span><span class="nv">`python_bin &lt;opt_python_bin&gt;`</span> (<span class="s">``&#39;python&#39;``</span>)

    Interpreter to launch your script with. Defaults to the value
    of <span class="gs">**python_bin**</span>, which is deprecated. Change this if you&#39;re
    using a language besides Python 2.5-2.7 or if you&#39;re running
    using <span class="na">:py:mod:</span><span class="nv">`virtualenv`</span>.
</pre></div>


<p>And you&#8217;re&nbsp;done.</p>
<p>I&#8217;ll be the first to admit that the above syntax still has flaws. But it has a
few key&nbsp;advantages:</p>
<ol>
<li>
<p>You don&#8217;t need to edit the reference table by hand. Fewer duplications of
   text and no idiotic <span class="caps">RST</span>&nbsp;tables.</p>
</li>
<li>
<p>You define the different components of the option (config key, command line
   switches, default value) semantically instead of by&nbsp;convention.</p>
</li>
</ol>
<p>In the future, I&#8217;d like to have it automatically generate the <code>opt_X</code> and
<code>:type:</code> links to remove even more manual labor from the process of documenting
options, but this is enough of an improvement that I went ahead and submitted a
<a href="pr">pull request</a> for&nbsp;it.</p>
<h1 id="how-i-wrote-the-extension">How I wrote the&nbsp;extension</h1>
<p>This section will describe not only how the code works, but also how I went
about learning how to write Sphinx extensions and how to get the results I&nbsp;wanted.</p></div>
  </article></section>
    <footer id="pagefooter" class="body">
      <div class="social-links">
        <!--
          <a href="http://steveasleep.com/feeds/all.rss.xml">RSS</a>
        -->
        <a href="http://github.com/irskep">GitHub</a><br>
        <a href="http://twitter.com/irskep">Twitter</a><br>
        <a href="http://www.last.fm/user/irskep">Last.fm</a><br>
      </div>
      Stephen R. Johnson<br>
      <a href="mailto:steve@steveasleep.com">steve@steveasleep.com</a><br>
      San Francisco, California
    </footer><!-- /#pagefooter -->
  </div>

  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4517625-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</body>
</html>